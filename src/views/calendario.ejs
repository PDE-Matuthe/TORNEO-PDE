<%- include('partials/head') %>
<%- include('partials/nav') %>

<main class="max-w-7xl mx-auto px-4 py-8">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-4xl font-bold mb-2">
      <i class="fas fa-calendar text-gold mr-3"></i> Calendario de Partidas
    </h1>
    <p class="text-slate-400">Sigue el cronograma completo del torneo</p>
  </div>

  <% 
    // Agrupar partidas por fecha
    const today = new Date();
    const todayLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const groupedByDate = {};
    
    if (typeof partidas !== 'undefined' && Array.isArray(partidas)) {
      partidas.forEach(match => {
        const matchDate = new Date(match.fecha_partida);
        const matchLocal = new Date(matchDate.getFullYear(), matchDate.getMonth(), matchDate.getDate());
        const dateKey = matchLocal.toISOString().split('T')[0];
        
        if (!groupedByDate[dateKey]) {
          groupedByDate[dateKey] = [];
        }
        groupedByDate[dateKey].push(match);
      });
    }
    
    const sortedDates = Object.keys(groupedByDate).sort();
    const todayKey = todayLocal.toISOString().split('T')[0];
  %>

  <% if (sortedDates.length === 0) { %>
    <div class="card text-center py-12">
      <i class="fas fa-calendar-times text-6xl text-slate-600 mb-4"></i>
      <h2 class="text-2xl font-bold text-slate-300">No hay partidas programadas</h2>
      <p class="text-slate-400 mt-2">Pronto se publicar√°n las partidas del torneo</p>
    </div>
  <% } else { %>
    <!-- Partidas Futuras -->
    <% const futureDates = sortedDates.filter(d => d >= todayKey); %>
    <% if (futureDates.length > 0) { %>
      <h2 class="text-2xl font-bold text-gold mb-6">
        <i class="fas fa-arrow-right mr-2"></i> Pr√≥ximos Encuentros
      </h2>
      
      <div class="space-y-4 mb-12">
        <% futureDates.forEach(dateKey => { %>
          <% const dateObj = new Date(dateKey + 'T00:00:00'); %>
          <% const dayName = dateObj.toLocaleDateString('es-ES', { weekday: 'long' }); %>
          <% const dateFormatted = dateObj.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' }); %>
          
          <div class="bg-slate-800 rounded-lg overflow-hidden">
            <div class="bg-gradient-to-r from-slate-700 to-slate-800 px-4 py-3 border-l-4 border-gold">
              <p class="font-bold text-white capitalize"><%= dayName %></p>
              <p class="text-slate-400 text-sm"><%= dateFormatted %></p>
            </div>
            
            <div class="divide-y divide-slate-700">
              <% groupedByDate[dateKey].forEach(match => { %>
                <div class="p-4 hover:bg-slate-700 transition">
                  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <!-- Team Azul -->
                    <div class="flex items-center gap-3 flex-1">
                      <% if (match.equipo1 && match.equipo1.logoUrl) { %>
                        <img src="<%= match.equipo1.logoUrl %>" alt="<%= match.equipo1.nombre %>" class="w-12 h-12 object-contain">
                      <% } else { %>
                        <div class="w-12 h-12 bg-slate-600 rounded flex items-center justify-center">
                          <i class="fas fa-shield-alt text-slate-400"></i>
                        </div>
                      <% } %>
                      <div>
                        <p class="font-bold text-white"><%= match.equipo1 ? match.equipo1.nombre : 'TBD' %></p>
                        <p class="text-xs text-slate-500">Equipo Azul</p>
                      </div>
                    </div>
                    
                    <!-- Score / Time -->
                    <div class="flex flex-col items-center md:px-8 py-2 md:py-0">
                      <% if (match.estado === 'completada') { %>
                        <div class="text-center">
                          <p class="text-2xl font-bold">
                            <span class="<%= match.ganador_color === 'azul' ? 'text-blue-400' : 'text-slate-400' %>"><%= match.puntos_equipo1 %></span>
                            -
                            <span class="<%= match.ganador_color === 'rojo' ? 'text-red-400' : 'text-slate-400' %>"><%= match.puntos_equipo2 %></span>
                          </p>
                          <p class="text-xs text-green-500 font-bold">FINALIZADA</p>
                        </div>
                      <% } else { %>
                        <p class="text-slate-400 text-sm">
                          <i class="fas fa-clock mr-1"></i>
                          <%= new Date(match.fecha_partida).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) %>
                        </p>
                        <p class="text-xs text-slate-500 font-bold mt-1">Pr√≥ximamente</p>
                      <% } %>
                    </div>
                    
                    <!-- Team Rojo -->
                    <div class="flex items-center gap-3 flex-1 md:flex-row-reverse">
                      <% if (match.equipo2 && match.equipo2.logoUrl) { %>
                        <img src="<%= match.equipo2.logoUrl %>" alt="<%= match.equipo2.nombre %>" class="w-12 h-12 object-contain">
                      <% } else { %>
                        <div class="w-12 h-12 bg-slate-600 rounded flex items-center justify-center">
                          <i class="fas fa-shield-alt text-slate-400"></i>
                        </div>
                      <% } %>
                      <div class="md:text-right">
                        <p class="font-bold text-white"><%= match.equipo2 ? match.equipo2.nombre : 'TBD' %></p>
                        <p class="text-xs text-slate-500">Equipo Rojo</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Fase Info -->
                  <div class="mt-3 pt-3 border-t border-slate-700">
                    <p class="text-xs text-slate-400">
                      <i class="fas fa-layer-group mr-1"></i> 
                      <span class="text-gold"><%= match.fase_torneo || 'Fase General' %></span>
                      <% if (match.nombre_torneo) { %>
                        <span class="mx-2">|</span>
                        <%= match.nombre_torneo %>
                      <% } %>
                    </p>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>

    <!-- Partidas Pasadas -->
    <% const pastDates = sortedDates.filter(d => d < todayKey); %>
    <% if (pastDates.length > 0) { %>
      <h2 class="text-2xl font-bold text-slate-400 mb-6 mt-12">
        <i class="fas fa-history mr-2"></i> Resultados Anteriores
      </h2>
      
      <div class="space-y-4">
        <% pastDates.reverse().slice(0, 10).forEach(dateKey => { %>
          <% const dateObj = new Date(dateKey + 'T00:00:00'); %>
          <% const dayName = dateObj.toLocaleDateString('es-ES', { weekday: 'long' }); %>
          <% const dateFormatted = dateObj.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' }); %>
          
          <div class="bg-slate-800 rounded-lg overflow-hidden opacity-75">
            <div class="bg-gradient-to-r from-slate-700 to-slate-800 px-4 py-3 border-l-4 border-slate-600">
              <p class="font-bold text-slate-300 capitalize"><%= dayName %></p>
              <p class="text-slate-500 text-sm"><%= dateFormatted %></p>
            </div>
            
            <div class="divide-y divide-slate-700">
              <% groupedByDate[dateKey].forEach(match => { %>
                <div class="p-4">
                  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <!-- Team Azul -->
                    <div class="flex items-center gap-3 flex-1">
                      <% if (match.equipo1 && match.equipo1.logoUrl) { %>
                        <img src="<%= match.equipo1.logoUrl %>" alt="<%= match.equipo1.nombre %>" class="w-12 h-12 object-contain">
                      <% } %>
                      <div>
                        <p class="font-bold <%= match.ganador_color === 'azul' ? 'text-blue-400' : 'text-slate-400' %>">
                          <%= match.equipo1 ? match.equipo1.nombre : 'TBD' %>
                        </p>
                      </div>
                    </div>
                    
                    <!-- Score -->
                    <div class="text-center">
                      <p class="text-xl font-bold">
                        <span class="<%= match.ganador_color === 'azul' ? 'text-blue-400' : '' %>"><%= match.puntos_equipo1 %></span>
                        -
                        <span class="<%= match.ganador_color === 'rojo' ? 'text-red-400' : '' %>"><%= match.puntos_equipo2 %></span>
                      </p>
                    </div>
                    
                    <!-- Team Rojo -->
                    <div class="flex items-center gap-3 flex-1 md:flex-row-reverse">
                      <% if (match.equipo2 && match.equipo2.logoUrl) { %>
                        <img src="<%= match.equipo2.logoUrl %>" alt="<%= match.equipo2.nombre %>" class="w-12 h-12 object-contain">
                      <% } %>
                      <div class="md:text-right">
                        <p class="font-bold <%= match.ganador_color === 'rojo' ? 'text-red-400' : 'text-slate-400' %>">
                          <%= match.equipo2 ? match.equipo2.nombre : 'TBD' %>
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>
  <% } %>
</main>

<%- include('partials/footer') %>
          <div class="card card-custom">
            <% matchesForDate.forEach((match, index) => { %>
              <div class="p-4" style="border-bottom: 1px solid rgba(117, 20, 21, 0.3); <%= index === matchesForDate.length - 1 ? 'border-bottom: none;' : '' %>">
                <div class="row align-items-center">
                  <!-- Hora -->
                  <div class="col-md-1 text-center">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--color-amarillo);">
                      <%= new Date(match.fecha_partida).getHours().toString().padStart(2, '0') %>:<%= new Date(match.fecha_partida).getMinutes().toString().padStart(2, '0') %>
                    </div>
                  </div>

                  <!-- Equipo Azul -->
                  <div class="col-md-2 text-center">
                    <img src="<%= match.azul_logo || 'https://via.placeholder.com/50' %>" 
                         class="rounded-circle mb-2" 
                         style="width: 50px; height: 50px; object-fit: cover; border: 2px solid <%= match.ganador_id === match.azul_id ? 'var(--color-amarillo)' : 'var(--color-rojo-oscuro)' %>;">
                    <div style="color: var(--color-gris-claro); font-weight: 600; font-size: 0.9rem;">
                      <%= match.azul_nombre %>
                    </div>
                  </div>

                  <!-- VS / Estado -->
                  <div class="col-md-2 text-center">
                    <% if (match.ganador_id) { %>
                      <span class="badge" style="background-color: #4caf50; color: white; padding: 0.5rem 0.75rem; font-size: 0.85rem;">‚úì Finalizado</span>
                    <% } else { %>
                      <span style="color: var(--color-amarillo); font-weight: bold; font-size: 1rem;">VS</span>
                    <% } %>
                  </div>

                  <!-- Equipo Rojo -->
                  <div class="col-md-2 text-center">
                    <img src="<%= match.rojo_logo || 'https://via.placeholder.com/50' %>" 
                         class="rounded-circle mb-2" 
                         style="width: 50px; height: 50px; object-fit: cover; border: 2px solid <%= match.ganador_id === match.rojo_id ? 'var(--color-amarillo)' : 'var(--color-rojo-oscuro)' %>;">
                    <div style="color: var(--color-gris-claro); font-weight: 600; font-size: 0.9rem;">
                      <%= match.rojo_nombre %>
                    </div>
                  </div>

                  <!-- Fase -->
                  <div class="col-md-2 text-center">
                    <span class="badge" style="background-color: var(--color-rojo-oscuro); color: var(--color-amarillo);">
                      <%= match.fase_torneo %>
                    </span>
                  </div>

                  <!-- Admin Actions -->
                  <% if (isAuthenticated) { %>
                    <div class="col-md-3 text-center">
                      <div class="d-flex gap-2 justify-content-center flex-wrap">
                        <a href="/admin/partidas/<%= match.id %>/stats" class="btn btn-sm btn-custom" title="Cargar Stats">
                          üìä Stats
                        </a>
                        <a href="/admin/partidas/delete/<%= match.id %>" class="btn btn-sm" style="background-color: #c72c3a; color: var(--color-amarillo);" onclick="return confirm('¬øBorrar partido?')" title="Eliminar">
                          üóëÔ∏è
                        </a>
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>

  <!-- Secci√≥n HOY -->
  <div class="mb-5" id="seccionHoy">
    <h2 style="color: var(--color-amarillo); margin-bottom: 2rem;">üî¥ Partidas de Hoy</h2>
    <% if (todayMatches.length > 0) { %>
      <div class="card card-custom">
        <% todayMatches.forEach((match, index) => { %>
          <div class="p-4" style="border-bottom: 1px solid rgba(117, 20, 21, 0.3); <%= index === todayMatches.length - 1 ? 'border-bottom: none;' : '' %>">
            <div class="row align-items-center">
              <!-- Hora -->
              <div class="col-md-1 text-center">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--color-amarillo);">
                  <%= new Date(match.fecha_partida).getHours().toString().padStart(2, '0') %>:<%= new Date(match.fecha_partida).getMinutes().toString().padStart(2, '0') %>
                </div>
              </div>

              <!-- Equipo Azul -->
              <div class="col-md-2 text-center">
                <img src="<%= match.azul_logo || 'https://via.placeholder.com/50' %>" 
                     class="rounded-circle mb-2" 
                     style="width: 50px; height: 50px; object-fit: cover; border: 3px solid <%= match.ganador_id === match.azul_id ? 'var(--color-amarillo)' : 'var(--color-rojo-oscuro)' %>;">
                <div style="color: var(--color-gris-claro); font-weight: 600; font-size: 0.9rem;">
                  <%= match.azul_nombre %>
                </div>
              </div>

              <!-- VS / Estado -->
              <div class="col-md-2 text-center">
                <% if (match.ganador_id) { %>
                  <span class="badge" style="background-color: #4caf50; color: white; padding: 0.5rem 0.75rem;">‚úì Finalizado</span>
                <% } else { %>
                  <span style="color: var(--color-amarillo); font-weight: bold; font-size: 1rem;">VS</span>
                <% } %>
              </div>

              <!-- Equipo Rojo -->
              <div class="col-md-2 text-center">
                <img src="<%= match.rojo_logo || 'https://via.placeholder.com/50' %>" 
                     class="rounded-circle mb-2" 
                     style="width: 50px; height: 50px; object-fit: cover; border: 3px solid <%= match.ganador_id === match.rojo_id ? 'var(--color-amarillo)' : 'var(--color-rojo-oscuro)' %>;">
                <div style="color: var(--color-gris-claro); font-weight: 600; font-size: 0.9rem;">
                  <%= match.rojo_nombre %>
                </div>
              </div>

              <!-- Fase -->
              <div class="col-md-2 text-center">
                <span class="badge" style="background-color: var(--color-rojo-oscuro); color: var(--color-amarillo);">
                  <%= match.fase_torneo %>
                </span>
              </div>

              <!-- Admin Actions -->
              <% if (isAuthenticated) { %>
                <div class="col-md-3 text-center">
                  <div class="d-flex gap-2 justify-content-center flex-wrap">
                    <a href="/admin/partidas/<%= match.id %>/stats" class="btn btn-sm btn-custom">
                      üìä Stats
                    </a>
                    
                    <% if (!match.ganador_id) { %>
                      <form action="/admin/partidas/ganador" method="POST" class="d-inline">
                        <input type="hidden" name="partidaId" value="<%= match.id %>">
                        <button type="submit" name="ganadorId" value="<%= match.azul_id %>" class="btn btn-sm" style="background-color: #3498db; color: white;">
                          üü¶ <%= match.azul_nombre %>
                        </button>
                      </form>
                      <form action="/admin/partidas/ganador" method="POST" class="d-inline">
                        <input type="hidden" name="partidaId" value="<%= match.id %>">
                        <button type="submit" name="ganadorId" value="<%= match.rojo_id %>" class="btn btn-sm" style="background-color: #e74c3c; color: white;">
                          üü• <%= match.rojo_nombre %>
                        </button>
                      </form>
                    <% } else { %>
                      <button type="button" class="btn btn-sm" style="background-color: #4caf50; color: white;" disabled>Cerrado</button>
                    <% } %>
                    
                    <a href="/admin/partidas/delete/<%= match.id %>" class="btn btn-sm" style="background-color: #c72c3a; color: var(--color-amarillo);" onclick="return confirm('¬øBorrar partido?')">
                      üóëÔ∏è
                    </a>
                  </div>
                </div>
              <% } %>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="card card-custom">
        <div class="card-body text-center p-5">
          <p style="color: var(--color-gris-claro); font-size: 1.1rem;">No hay partidas programadas para hoy</p>
          <small style="color: rgba(221, 221, 221, 0.7);">¬°Vuelve a consultar pronto!</small>
        </div>
      </div>
    <% } %>
  </div>

  <!-- Pr√≥ximos d√≠as -->
  <% 
    const futureDates = sortedDates.filter(dateKey => dateKey !== todayKey && dateKey > todayKey);
    if (futureDates.length > 0) { 
  %>
    <div class="mb-5">
      <h2 style="color: var(--color-amarillo); margin-bottom: 2rem;">‚è∞ Pr√≥ximas Partidas</h2>
      <% futureDates.forEach(dateKey => { %>
        <% 
          const matchesForDate = groupedByDate[dateKey];
          const dateObj = new Date(dateKey + 'T00:00:00');
          const dayName = dateObj.toLocaleDateString('es-ES', { weekday: 'long' });
          const dateFormatted = dateObj.toLocaleDateString('es-ES');
        %>
        <div class="mb-4">
          <h4 style="color: var(--color-amarillo); margin-bottom: 1.5rem; font-weight: 600; border-bottom: 2px solid var(--color-rojo-oscuro); padding-bottom: 0.5rem;">
            <%= dayName.charAt(0).toUpperCase() + dayName.slice(1) %> - <%= dateFormatted %>
          </h4>
          <div class="card card-custom">
            <% matchesForDate.forEach((match, index) => { %>
              <div class="p-4" style="border-bottom: 1px solid rgba(117, 20, 21, 0.3); <%= index === matchesForDate.length - 1 ? 'border-bottom: none;' : '' %>">
                <div class="row align-items-center">
                  <!-- Hora -->
                  <div class="col-md-1 text-center">
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--color-amarillo);">
                      <%= new Date(match.fecha_partida).getHours().toString().padStart(2, '0') %>:<%= new Date(match.fecha_partida).getMinutes().toString().padStart(2, '0') %>
                    </div>
                  </div>

                  <!-- Equipo Azul -->
                  <div class="col-md-2 text-center">
                    <img src="<%= match.azul_logo || 'https://via.placeholder.com/50' %>" 
                         class="rounded-circle mb-2" 
                         style="width: 50px; height: 50px; object-fit: cover; border: 2px solid var(--color-rojo-oscuro);">
                    <div style="color: var(--color-gris-claro); font-weight: 600; font-size: 0.9rem;">
                      <%= match.azul_nombre %>
                    </div>
                  </div>

                  <!-- VS -->
                  <div class="col-md-2 text-center">
                    <span style="color: var(--color-amarillo); font-weight: bold; font-size: 1rem;">VS</span>
                  </div>

                  <!-- Equipo Rojo -->
                  <div class="col-md-2 text-center">
                    <img src="<%= match.rojo_logo || 'https://via.placeholder.com/50' %>" 
                         class="rounded-circle mb-2" 
                         style="width: 50px; height: 50px; object-fit: cover; border: 2px solid var(--color-rojo-oscuro);">
                    <div style="color: var(--color-gris-claro); font-weight: 600; font-size: 0.9rem;">
                      <%= match.rojo_nombre %>
                    </div>
                  </div>

                  <!-- Fase -->
                  <div class="col-md-2 text-center">
                    <span class="badge" style="background-color: var(--color-rojo-oscuro); color: var(--color-amarillo);">
                      <%= match.fase_torneo %>
                    </span>
                  </div>

                  <!-- Admin Actions -->
                  <% if (isAuthenticated) { %>
                    <div class="col-md-3 text-center">
                      <div class="d-flex gap-2 justify-content-center flex-wrap">
                        <a href="/admin/partidas/<%= match.id %>/stats" class="btn btn-sm btn-custom">
                          üìä Stats
                        </a>
                        
                        <% if (!match.ganador_id) { %>
                          <form action="/admin/partidas/ganador" method="POST" class="d-inline">
                            <input type="hidden" name="partidaId" value="<%= match.id %>">
                            <button type="submit" name="ganadorId" value="<%= match.azul_id %>" class="btn btn-sm" style="background-color: #3498db; color: white;">
                              üü¶ Gana
                            </button>
                          </form>
                          <form action="/admin/partidas/ganador" method="POST" class="d-inline">
                            <input type="hidden" name="partidaId" value="<%= match.id %>">
                            <button type="submit" name="ganadorId" value="<%= match.rojo_id %>" class="btn btn-sm" style="background-color: #e74c3c; color: white;">
                              üü• Gana
                            </button>
                          </form>
                        <% } else { %>
                          <button type="button" class="btn btn-sm" style="background-color: #4caf50; color: white;" disabled>Cerrado</button>
                        <% } %>
                        
                        <a href="/admin/partidas/delete/<%= match.id %>" class="btn btn-sm" style="background-color: #c72c3a; color: var(--color-amarillo);" onclick="return confirm('¬øBorrar partido?')">
                          üóëÔ∏è
                        </a>
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>

  <!-- Sin partidas -->
  <% if (partidas.length === 0) { %>
    <div class="card card-custom">
      <div class="card-body text-center p-5">
        <h3 style="color: var(--color-amarillo); margin-bottom: 1rem;">A√∫n no hay partidas programadas</h3>
        <p style="color: var(--color-gris-claro);">¬°Vuelve pronto para ver los enfrentamientos del torneo!</p>
      </div>
    </div>
  <% } %>
</div>

<script>
  // Hacer scroll a la secci√≥n "Hoy" cuando la p√°gina carga
  window.addEventListener('load', function() {
    const seccionHoy = document.getElementById('seccionHoy');
    if (seccionHoy) {
      seccionHoy.scrollIntoView({ behavior: 'smooth' });
    }
  });
</script>

<%- include('partials/footer') %>
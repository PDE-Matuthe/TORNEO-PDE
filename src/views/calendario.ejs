<%- include('partials/head') %>
<%- include('partials/nav') %>

<% 
  const today = new Date();
  const todayLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const todayKey = todayLocal.toISOString().split('T')[0];

  const groupedByDate = {};
  
  if (typeof partidas !== 'undefined' && Array.isArray(partidas)) {
    partidas.forEach(match => {
      const matchDate = new Date(match.fecha_partida);
      const localDate = new Date(matchDate.getFullYear(), matchDate.getMonth(), matchDate.getDate());
      const dateKey = localDate.toISOString().split('T')[0];
      
      if (!groupedByDate[dateKey]) groupedByDate[dateKey] = [];
      groupedByDate[dateKey].push(match);
    });
  }
  
  const sortedDates = Object.keys(groupedByDate).sort();
  const todayMatches = groupedByDate[todayKey] || [];
  const futureDates = sortedDates.filter(d => d > todayKey);
%>

<main class="max-w-5xl mx-auto px-4 py-10">

  <div class="text-center mb-10">
    <% if (typeof isTorneoEspecifico !== 'undefined' && isTorneoEspecifico) { %>
      <div class="mb-4 flex items-center justify-center gap-2">
        <a href="/torneos-anteriores" class="text-gold hover:text-yellow-400 text-sm">Torneos Anteriores</a>
        <span class="text-slate-500">/</span>
        <span class="text-slate-400 text-sm"><%= torneo.nombre %></span>
      </div>
    <% } %>
    <h1 class="text-4xl font-bold text-white mb-2">Calendario de Partidas<% if (typeof isTorneoEspecifico !== 'undefined' && isTorneoEspecifico) { %> - <%= torneo.nombre %><% } %></h1>
    <p class="text-slate-400">Cronograma oficial del torneo</p>
  </div>

  <div class="mb-12" id="seccionHoy">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-1 h-6 bg-red-500 rounded-full"></div>
      <h2 class="text-2xl font-bold text-white">Hoy</h2>
      <% if(todayMatches.length > 0) { %>
        <span class="bg-red-500/10 text-red-500 text-xs font-bold px-2 py-1 rounded animate-pulse">EN VIVO</span>
      <% } %>
    </div>

    <% if (todayMatches.length > 0) { %>
      <div class="space-y-3">
        <% todayMatches.forEach(match => { %>
          <div class="bg-slate-800 rounded-lg p-4 border-l-4 border-yellow-500 flex flex-col md:flex-row items-center justify-between gap-4 hover:bg-slate-750 transition shadow-lg">
            
            <div class="text-center md:text-left min-w-[80px]">
              <span class="text-2xl font-bold text-white">
                <%= new Date(match.fecha_partida).getHours().toString().padStart(2, '0') %>:<%= new Date(match.fecha_partida).getMinutes().toString().padStart(2, '0') %>
              </span>
            </div>

            <div class="flex-1 flex items-center justify-center gap-6 w-full">
              <div class="flex items-center gap-3 flex-1 justify-end">
                <span class="text-white font-bold text-lg hidden sm:block"><%= match.azul_nombre %></span>
                <img src="<%= match.azul_logo %>" class="w-10 h-10 object-contain drop-shadow">
              </div>

              <div class="px-4 py-1 bg-slate-900 rounded-md font-bold text-slate-400 min-w-[60px] text-center">
                <% if(match.ganador_id) { %>
                  <span class="text-green-500">FIN</span>
                <% } else { %>
                  VS
                <% } %>
              </div>

              <div class="flex items-center gap-3 flex-1 justify-start">
                <img src="<%= match.rojo_logo %>" class="w-10 h-10 object-contain drop-shadow">
                <span class="text-white font-bold text-lg hidden sm:block"><%= match.rojo_nombre %></span>
              </div>
            </div>

            <div class="flex flex-col items-center md:items-end gap-2 min-w-[100px]">
              <span class="text-xs text-slate-500 uppercase font-bold tracking-wider"><%= match.fase_torneo %></span>
              
              <% if (locals.isLoggedIn) { %>
                <div class="flex gap-2">
                  <a href="/admin/partidas/<%= match.id %>/stats" class="text-xs bg-yellow-600 hover:bg-yellow-500 text-white px-2 py-1 rounded">Stats</a>
                  <a href="/admin/partidas/delete/<%= match.id %>" onclick="return confirm('¿Eliminar?')" class="text-xs bg-red-900 text-red-200 hover:text-white px-2 py-1 rounded">Borrar</a>
                </div>
              <% } %>
            </div>

          </div>
        <% }) %>
      </div>
    <% } else { %>
      <div class="p-8 border border-slate-700 border-dashed rounded-lg text-center">
        <p class="text-slate-500">No hay partidas programadas para el día de hoy.</p>
      </div>
    <% } %>
  </div>

  <% if (futureDates.length > 0) { %>
    <div class="mb-12">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-1 h-6 bg-yellow-500 rounded-full"></div>
        <h2 class="text-2xl font-bold text-white">Próximamente</h2>
      </div>

      <div class="space-y-8">
        <% futureDates.forEach(dateKey => { %>
          <% 
            const dateObj = new Date(dateKey + 'T00:00:00');
            const dayName = dateObj.toLocaleDateString('es-ES', { weekday: 'long' });
            const dateFormatted = dateObj.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
          %>
          
          <div>
            <h3 class="text-yellow-500 font-bold capitalize mb-3 ml-2 text-lg">
              <%= dayName %> <span class="text-slate-500 text-sm font-normal normal-case ml-2"><%= dateFormatted %></span>
            </h3>

            <div class="space-y-2">
              <% groupedByDate[dateKey].forEach(match => { %>
                <div class="bg-slate-800/50 hover:bg-slate-800 rounded px-4 py-3 flex items-center justify-between gap-4 transition border border-slate-700/50">
                  
                  <div class="text-slate-300 font-mono font-bold">
                    <%= new Date(match.fecha_partida).getHours().toString().padStart(2, '0') %>:<%= new Date(match.fecha_partida).getMinutes().toString().padStart(2, '0') %>
                  </div>

                  <div class="flex items-center gap-3">
                    <img src="<%= match.azul_logo %>" class="w-6 h-6 object-contain opacity-80">
                    <span class="text-slate-400 text-sm font-bold">VS</span>
                    <img src="<%= match.rojo_logo %>" class="w-6 h-6 object-contain opacity-80">
                  </div>

                  <div class="hidden md:flex items-center gap-2 text-sm text-slate-400">
                    <span><%= match.azul_nombre %></span>
                    <span>vs</span>
                    <span><%= match.rojo_nombre %></span>
                  </div>

                  <div class="text-xs text-slate-600 bg-slate-900 px-2 py-1 rounded border border-slate-800">
                    <%= match.fase_torneo %>
                  </div>
                  
                  <% if (locals.isLoggedIn) { %>
                     <a href="/admin/partidas/<%= match.id %>/stats" class="text-xs text-yellow-500 hover:text-white hover:underline">Editar</a>
                  <% } %>

                </div>
              <% }) %>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  <% } %>

  <% if (partidas.length === 0) { %>
    <div class="text-center py-20 opacity-50">
      <i class="fas fa-calendar text-6xl text-slate-600 mb-4"></i>
      <p class="text-slate-400 text-xl">Aún no se ha publicado el calendario.</p>
    </div>
  <% } %>

</main>

<script>
  window.addEventListener('load', function() {
    const el = document.getElementById('seccionHoy');
    if(el && <%= todayMatches.length > 0 %>) el.scrollIntoView({ behavior: 'smooth' });
  });
</script>

<%- include('partials/footer') %>
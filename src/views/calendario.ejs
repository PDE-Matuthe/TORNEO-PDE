<%- include('partials/head') %>
<%- include('partials/nav') %>

<% const STREAM_CHANNEL_URL = "https://www.twitch.tv/nachopunto2"; %>

<main class="max-w-7xl mx-auto px-4 py-12">

  <div class="text-center mb-16 relative">
    <h1 class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-700 uppercase italic tracking-tighter drop-shadow-sm">
      Calendario
    </h1>
    <p class="text-slate-400 text-lg mt-2 font-light tracking-widest uppercase">
      Temporada 2026
    </p>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-yellow-500/10 blur-[100px] -z-10 rounded-full"></div>
  </div>

  <% 
    const now = new Date();
    const todayString = now.toISOString().split('T')[0];
    let matchesToday = [];
    let matchesFuture = [];
    let matchesPast = [];

    if (typeof partidas !== 'undefined' && Array.isArray(partidas)) {
      partidas.forEach(match => {
        const matchDate = new Date(match.fecha_partida);
        const matchDateString = matchDate.toISOString().split('T')[0];
        
        // Solo es "Live" si el Admin puso el estado 'EN_VIVO'
        match.isLive = (match.estado === 'EN_VIVO');
        
        if (matchDateString === todayString) matchesToday.push(match);
        else if (matchDate > now) matchesFuture.push(match);
        else matchesPast.push(match);
      });
    }

    // Ordenar
    matchesFuture.sort((a, b) => new Date(a.fecha_partida) - new Date(b.fecha_partida));
    matchesPast.sort((a, b) => new Date(b.fecha_partida) - new Date(a.fecha_partida));

    function formatDate(dateStr) {
        return new Date(dateStr).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
    }
  %>

  <div class="space-y-16 max-w-5xl mx-auto">

    <% if (matchesToday.length > 0) { %>
      <section>
        <h2 class="text-3xl font-black text-white italic uppercase mb-8 border-l-4 border-yellow-500 pl-4">
          Jugando Hoy
        </h2>
        <div class="grid gap-6">
          <% matchesToday.forEach(match => { %>
             
            <% if (match.isLive) { %>
               <a href="<%= STREAM_CHANNEL_URL %>" target="_blank" class="block transform transition hover:scale-[1.01] hover:shadow-[0_0_30px_rgba(220,38,38,0.3)] rounded-xl relative group cursor-pointer">
                  <div class="absolute -top-3 right-4 z-30 bg-red-600 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg animate-pulse border border-red-500">
                     üî¥ EN VIVO - CLIC PARA VER
                  </div>
            <% } else { %>
               <div class="relative group block rounded-xl">
            <% } %>

                  <div class="relative overflow-hidden rounded-xl">
                      
                      <div class="absolute inset-0 bg-gradient-to-r from-slate-800 to-slate-900 border border-slate-700 transform -skew-x-6 scale-105 rounded-xl shadow-xl group-hover:border-yellow-500/30 transition-all duration-300"></div>
                      
                      <div class="relative z-10 p-6 flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="text-center md:text-left min-w-[100px]">
                          <% if (match.isLive) { %>
                            <div class="inline-block px-2 py-0.5 bg-red-600 text-white text-[10px] font-bold uppercase tracking-widest rounded animate-pulse mb-1 shadow-[0_0_10px_red]">Transmisi√≥n</div>
                          <% } else if (match.estado === 'FINALIZADO') { %>
                             <div class="text-green-500 text-xs font-bold uppercase tracking-widest">Finalizado</div>
                          <% } else { %>
                            <div class="text-3xl font-black text-white italic font-mono">
                               <%= new Date(match.fecha_partida).getHours().toString().padStart(2, '0') %>:<%= new Date(match.fecha_partida).getMinutes().toString().padStart(2, '0') %>
                            </div>
                            <div class="text-slate-500 text-xs font-bold uppercase tracking-widest">Hora Local</div>
                          <% } %>
                        </div>

                        <div class="flex-1 flex items-center justify-center gap-8 w-full">
                           <div class="flex items-center gap-4 text-right justify-end flex-1">
                              <span class="text-xl font-black text-white italic uppercase tracking-tighter"><%= match.azul_nombre %></span>
                              <img src="<%= match.azul_logo %>" class="w-14 h-14 object-contain drop-shadow-lg transition-transform group-hover:scale-110">
                           </div>

                           <div class="text-2xl font-black text-slate-700 italic">VS</div>

                           <div class="flex items-center gap-4 text-left justify-start flex-1">
                              <img src="<%= match.rojo_logo %>" class="w-14 h-14 object-contain drop-shadow-lg transition-transform group-hover:scale-110">
                              <span class="text-xl font-black text-white italic uppercase tracking-tighter"><%= match.rojo_nombre %></span>
                           </div>
                        </div>

                        <div class="hidden md:block">
                           <span class="px-3 py-1 bg-slate-950/50 border border-slate-700 rounded text-xs font-bold text-slate-400 uppercase tracking-widest">
                             <%= match.fase_torneo %>
                           </span>
                        </div>
                      </div>
                  </div>

            <% if (match.isLive) { %> </a> <% } else { %> </div> <% } %>

          <% }) %>
        </div>
      </section>
    <% } %>

    <% if (matchesFuture.length > 0) { %>
      <section>
        <h2 class="text-3xl font-black text-slate-500 italic uppercase mb-8 border-l-4 border-slate-700 pl-4">
          Pr√≥ximamente
        </h2>
        <div class="flex flex-col gap-4">
          <% 
             let lastDateFuture = '';
             matchesFuture.forEach(match => { 
                const thisDate = formatDate(match.fecha_partida);
                if (thisDate !== lastDateFuture) {
                   lastDateFuture = thisDate;
          %>
                   <h3 class="text-xl text-yellow-500 font-bold uppercase tracking-widest mt-6 mb-2 border-b border-slate-800 pb-2 capitalize">
                     <%= thisDate %>
                   </h3>
          <%    } %>
                
                <div class="relative group block perspective-1000">
                  <div class="absolute inset-0 bg-gradient-to-r from-slate-800 to-slate-900 border border-slate-700 transform -skew-x-6 scale-105 rounded-xl shadow-xl"></div>
                  <div class="relative z-10 p-6 flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="text-center md:text-left min-w-[100px]">
                        <div class="text-3xl font-black text-white italic font-mono">
                           <%= new Date(match.fecha_partida).getHours().toString().padStart(2, '0') %>:<%= new Date(match.fecha_partida).getMinutes().toString().padStart(2, '0') %>
                        </div>
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-widest">Hora Local</div>
                    </div>
                    <div class="flex-1 flex items-center justify-center gap-8 w-full">
                       <div class="flex items-center gap-4 text-right justify-end flex-1">
                          <span class="text-xl font-black text-white italic uppercase tracking-tighter"><%= match.azul_nombre %></span>
                          <img src="<%= match.azul_logo %>" class="w-14 h-14 object-contain drop-shadow-lg opacity-80">
                       </div>
                       <div class="text-2xl font-black text-slate-700 italic">VS</div>
                       <div class="flex items-center gap-4 text-left justify-start flex-1">
                          <img src="<%= match.rojo_logo %>" class="w-14 h-14 object-contain drop-shadow-lg opacity-80">
                          <span class="text-xl font-black text-white italic uppercase tracking-tighter"><%= match.rojo_nombre %></span>
                       </div>
                    </div>
                    <div class="hidden md:block">
                       <span class="px-3 py-1 bg-slate-950/50 border border-slate-700 rounded text-xs font-bold text-slate-500 uppercase tracking-widest"><%= match.fase_torneo %></span>
                    </div>
                  </div>
                </div>

          <% }) %>
        </div>
      </section>
    <% } %>

    <% if (matchesPast.length > 0) { %>
      <section>
        <h2 class="text-3xl font-black text-slate-500 italic uppercase mb-8 border-l-4 border-slate-700 pl-4">
          Resultados Anteriores
        </h2>
        <div class="flex flex-col gap-8">
          <% 
             let lastDatePast = '';
             matchesPast.forEach(match => { 
                 const thisDate = formatDate(match.fecha_partida);
                 const scoreAzul = (match.ganador_id === match.azul_id) ? 1 : 0;
                 const scoreRojo = (match.ganador_id === match.rojo_id) ? 1 : 0;

                 if (thisDate !== lastDatePast) {
                    lastDatePast = thisDate;
          %>
                    <h3 class="text-xl text-slate-400 font-bold uppercase tracking-widest mt-4 mb-2 border-b border-slate-800 pb-2 capitalize">
                      <%= thisDate %>
                    </h3>
          <%     } %>

             <div class="relative group perspective-1000 block w-full mx-auto" id="match-content-<%= match.id %>">
                <div class="absolute inset-0 bg-gradient-to-r from-slate-900 to-slate-800 border border-slate-700 transform -skew-x-6 scale-105 rounded-xl shadow-2xl"></div>
                
                <div class="relative z-10 p-6 flex flex-col md:flex-row items-center justify-between gap-6">
                    
                    <div class="text-center md:text-left md:w-32 flex-shrink-0 flex flex-col items-center md:items-start gap-2">
                        <div>
                            <div class="text-yellow-500 font-bold text-xs uppercase tracking-widest mb-1">Finalizado</div>
                            <div class="text-slate-500 font-bold text-sm">
                               <%= new Date(match.fecha_partida).getHours().toString().padStart(2, '0') %>:<%= new Date(match.fecha_partida).getMinutes().toString().padStart(2, '0') %>
                            </div>
                        </div>
                        <% if (match.vod_url) { %>
                            <a href="<%= match.vod_url %>" target="_blank" class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-500 text-white text-[10px] font-bold px-3 py-1 rounded transition shadow-lg border border-red-800 transform hover:scale-105">
                                <i class="fab fa-youtube"></i> VER VOD
                            </a>
                        <% } %>
                    </div>

                    <div class="flex-1 w-full flex items-center justify-center gap-4 md:gap-8">
                        <div class="flex-1 flex items-center justify-end gap-4 text-right team-blue transition-all duration-500">
                            <div class="hidden md:block">
                                <h3 class="text-2xl font-black text-white italic uppercase tracking-tighter"><%= match.azul_nombre %></h3>
                            </div>
                            <img src="<%= match.azul_logo %>" class="w-16 h-16 object-contain drop-shadow-lg logo-img">
                        </div>

                        <div class="min-w-[120px] flex flex-col items-center justify-center relative h-16">
                            <div class="spoiler-cover absolute inset-0 flex items-center justify-center z-20">
                                <button onclick="revealResult('<%= match.id %>', '<%= match.ganador_id %>', '<%= match.azul_id %>', '<%= match.rojo_id %>')" 
                                        class="bg-slate-700 hover:bg-yellow-500 hover:text-black text-white text-[10px] font-bold uppercase tracking-widest px-5 py-2 rounded transform -skew-x-12 transition shadow-lg border border-slate-600 hover:border-yellow-400">
                                    <span class="inline-block transform skew-x-12">Revelar</span>
                                </button>
                            </div>
                            <div class="spoiler-result opacity-0 transition-opacity duration-500 flex flex-col items-center justify-center scale-110">
                                <div class="text-4xl font-black text-white italic tracking-widest flex gap-4">
                                    <span class="score-azul text-slate-500"><%= scoreAzul %></span>
                                    <span class="text-slate-700">-</span>
                                    <span class="score-rojo text-slate-500"><%= scoreRojo %></span>
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 flex items-center justify-start gap-4 text-left team-red transition-all duration-500">
                            <img src="<%= match.rojo_logo %>" class="w-16 h-16 object-contain drop-shadow-lg logo-img">
                            <div class="hidden md:block">
                                <h3 class="text-2xl font-black text-white italic uppercase tracking-tighter"><%= match.rojo_nombre %></h3>
                            </div>
                        </div>
                    </div>

                    <div class="md:w-32 flex justify-end opacity-0 transition-opacity duration-500 details-btn">
                       <a href="/partida/<%= match.id %>" class="text-yellow-500 hover:text-white text-xs font-bold uppercase tracking-widest flex items-center gap-2 group">
                          Detalles <i class="fas fa-chevron-right transform group-hover:translate-x-1 transition"></i>
                       </a>
                    </div>
                </div>
             </div>
          <% }) %>
        </div>
      </section>
    <% } %>

  </div>
</main>

<script>
  function revealResult(matchId, winnerId, azulId, rojoId) {
    const container = document.getElementById('match-content-' + matchId);
    if(!container) return;

    // Elementos
    const cover = container.querySelector('.spoiler-cover');
    const result = container.querySelector('.spoiler-result');
    const detailsBtn = container.querySelector('.details-btn');
    
    // Equipos
    const blueTeam = container.querySelector('.team-blue');
    const redTeam = container.querySelector('.team-red');
    const scoreAzul = container.querySelector('.score-azul');
    const scoreRojo = container.querySelector('.score-rojo');

    // Acci√≥n
    cover.style.display = 'none';
    result.classList.remove('opacity-0');
    if(detailsBtn) detailsBtn.classList.remove('opacity-0');

    // Colorear Ganador
    if (winnerId === azulId) {
        // Gana Azul
        blueTeam.querySelector('h3')?.classList.add('text-yellow-400', 'drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]');
        scoreAzul.classList.remove('text-slate-500');
        scoreAzul.classList.add('text-yellow-400'); // El "1" en verde
        
        // Rojo pierde
        redTeam.classList.add('opacity-40', 'grayscale');
        scoreRojo.classList.add('text-white-500'); // El "0" en rojo
    } else if (winnerId === rojoId) {
        // Gana Rojo
        redTeam.querySelector('h3')?.classList.add('text-yellow-400', 'drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]');
        scoreRojo.classList.remove('text-slate-500');
        scoreRojo.classList.add('text-yellow-400');

        // Azul pierde
        blueTeam.classList.add('opacity-40', 'grayscale');
        scoreAzul.classList.add('text-white-500');
    }
  }
</script>

<%- include('partials/footer') %>
<%- include('partials/head') %>
<%- include('partials/nav') %>

<main class="max-w-[95vw] mx-auto py-12 overflow-x-auto min-h-screen bg-[#0a0a0c]">

  <div class="text-center mb-16 relative z-10">
    <h1 class="text-5xl md:text-6xl font-black text-white italic uppercase tracking-tighter mb-2 drop-shadow-lg">
      Fase Eliminatoria
    </h1>
    <p class="text-slate-400 uppercase tracking-widest text-xs font-bold">Camino al Campeonato</p>
  </div>

  <% 
     // --- LÓGICA DE DATOS ---
     const fasesOrder = ['Dieciseisavos', 'Octavos', 'Cuartos', 'Semifinal', 'Final'];
     const bracketData = {};
     fasesOrder.forEach(f => bracketData[f] = []);

     if (typeof partidas !== 'undefined' && Array.isArray(partidas)) {
         partidas.forEach(p => {
             if (p.fase_torneo) {
                 let faseKey = fasesOrder.find(f => p.fase_torneo.toUpperCase().includes(f.toUpperCase()));
                 if (faseKey) bracketData[faseKey].push(p);
             }
         });
     }

     let activeFases = fasesOrder.filter(f => bracketData[f].length > 0);
     if (activeFases.length === 0) activeFases = ['Octavos', 'Cuartos', 'Semifinal', 'Final'];
  %>

  <div class="flex flex-row items-stretch justify-center px-10 pb-20 min-w-max">

    <% activeFases.forEach((fase, faseIndex) => { 
         const matches = bracketData[fase] || [];
         
         // Cálculo de slots (relleno TBD)
         let idealCount = 0;
         if (faseIndex === activeFases.length - 1) idealCount = 1;
         else if (faseIndex === activeFases.length - 2) idealCount = 2;
         else if (faseIndex === activeFases.length - 3) idealCount = 4;
         else idealCount = Math.max(matches.length, 8);

         const loopCount = Math.max(matches.length, idealCount);
    %>

    <div class="flex flex-col justify-center relative min-w-[300px]">
        
        <div class="mb-6 text-center">
            <span class="bg-slate-800 text-yellow-500 px-4 py-1.5 text-[11px] font-black uppercase tracking-[0.2em] rounded border border-slate-700 shadow-lg">
                <%= fase %>
            </span>
        </div>
        
        <div class="flex flex-col justify-around flex-grow gap-6"> <% for(let i = 0; i < loopCount; i++) {
                   const match = matches[i];
            %>
                
                <div class="w-full bg-slate-900 border border-slate-700/60 rounded-lg overflow-hidden shadow-xl relative z-10 transition-all duration-300 hover:border-yellow-500/50 hover:shadow-[0_0_20px_rgba(234,179,8,0.1)] hover:-translate-y-1 group">
                    
                    <% if (match) { 
                         const isAzulWinner = match.ganador_id && match.ganador_id === match.azul_id;
                         const isRojoWinner = match.ganador_id && match.ganador_id === match.rojo_id;
                         const hasWinner = match.ganador_id ? true : false;
                    %>
                        <a href="/partida/<%= match.id %>" class="block">
                            <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800/50 bg-slate-900/50 <%= isAzulWinner ? 'bg-gradient-to-r from-green-900/10 to-transparent' : '' %>">
                                <div class="flex items-center gap-3">
                                    <img src="<%= match.azul_logo %>" class="w-6 h-6 object-contain drop-shadow-md" onerror="this.src='https://via.placeholder.com/24'">
                                    <span class="text-sm font-bold truncate max-w-[130px] <%= isAzulWinner ? 'text-yellow-400' : 'text-slate-200' %> transition-colors group-hover:text-white"><%= match.azul_nombre %></span>
                                </div>
                                <span class="font-mono font-bold text-slate-500"><%= hasWinner ? (isAzulWinner ? '1' : '0') : '-' %></span>
                            </div>

                            <div class="flex items-center justify-between px-4 py-3 <%= isRojoWinner ? 'bg-gradient-to-r from-green-900/10 to-transparent' : '' %>">
                                <div class="flex items-center gap-3">
                                    <img src="<%= match.rojo_logo %>" class="w-6 h-6 object-contain drop-shadow-md" onerror="this.src='https://via.placeholder.com/24'">
                                    <span class="text-sm font-bold truncate max-w-[130px] <%= isRojoWinner ? 'text-yellow-400' : 'text-slate-200' %> transition-colors group-hover:text-white"><%= match.rojo_nombre %></span>
                                </div>
                                <span class="font-mono font-bold text-slate-500"><%= hasWinner ? (isRojoWinner ? '1' : '0') : '-' %></span>
                            </div>
                        </a>
                        
                        <div class="px-3 py-1.5 bg-slate-950 flex justify-between items-center text-[9px] text-slate-600 font-bold uppercase tracking-wider border-t border-slate-800">
                            <span>#<%= match.id.substring(0,4) %></span>
                            <% if(match.estado === 'EN_VIVO') { %> 
                                <span class="text-red-500 animate-pulse flex items-center gap-1"><i class="fas fa-circle text-[6px]"></i> LIVE</span> 
                            <% } else if(match.estado === 'FINALIZADO') { %> 
                                <span class="text-green-600">Finalizado</span> 
                            <% } else { %>
                                <span><%= new Date(match.fecha_partida).toLocaleDateString(undefined, {month:'short', day:'numeric'}) %></span>
                            <% } %>
                        </div>

                    <% } else { %>
                        <div class="opacity-30 select-none grayscale">
                            <div class="flex items-center gap-3 px-4 py-3 border-b border-slate-800">
                                <div class="w-6 h-6 bg-slate-800 rounded-full"></div>
                                <span class="text-sm font-bold text-slate-500 italic">Por definir</span>
                            </div>
                            <div class="flex items-center gap-3 px-4 py-3">
                                <div class="w-6 h-6 bg-slate-800 rounded-full"></div>
                                <span class="text-sm font-bold text-slate-500 italic">Por definir</span>
                            </div>
                        </div>
                    <% } %>

                </div>
            <% } %>
        </div>
    </div>

    <% if (faseIndex < activeFases.length - 1) { %>
        <div class="flex flex-col items-center justify-center px-4 md:px-8">
            <div class="h-full w-px bg-gradient-to-b from-transparent via-slate-700 to-transparent relative">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-slate-900 border border-slate-700 rounded-full flex items-center justify-center shadow-lg z-20">
                    <i class="fas fa-chevron-right text-slate-500 text-xs"></i>
                </div>
            </div>
        </div>
    <% } %>

    <% }) %>

  </div>

</main>

<%- include('partials/footer') %>
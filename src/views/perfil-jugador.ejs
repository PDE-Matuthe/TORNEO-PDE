<%- include('partials/head') %>
<%- include('partials/nav') %>

<% const DDRAGON_VER = "16.3.1"; %>

<main class="max-w-7xl mx-auto px-4 py-12">

  <% if (typeof jugador !== 'undefined' && jugador) { 
      
     // 1. CORRECCIÓN DE VARIABLES (El error "stats is not defined" se arregla aquí)
     // El controlador manda 'resumen', no 'stats'.
     const r = resumen || {};
     
     // Usamos Number() para asegurar cálculos matemáticos
     const kills = Number(r.total_kills || 0);
     const deaths = Number(r.total_deaths || 0);
     const assists = Number(r.total_assists || 0);
     const games = Number(r.partidas_jugadas || 0);
     const wins = Number(r.victorias || 0);

     // Cálculos seguros (evitar división por cero)
     const kdaRatio = deaths === 0 ? (kills + assists) : ((kills + assists) / deaths).toFixed(2);
     const winrate = games > 0 ? ((wins / games) * 100).toFixed(0) : 0;
     const avgCs = games > 0 ? (Number(r.total_cs || 0) / games).toFixed(1) : 0;
     const avgDmg = games > 0 ? (Number(r.total_dmg || 0) / games / 1000).toFixed(1) : 0;

     // Campeón Principal (para el fondo)
     const mainChamp = (typeof topChampions !== 'undefined' && topChampions.length > 0) ? topChampions[0].champion_name : 'Aatrox';
     
     // Función para limpiar nombres raros (Wukong, Renata, etc.)
     function getChampId(name) {
          if (!name) return 'Aatrox';
          const exceptions = {
              "Wukong": "MonkeyKing", "Renata Glasc": "Renata", "Renata": "Renata",
              "Nunu & Willump": "Nunu", "Nunu": "Nunu", "Bel'Veth": "Belveth",
              "Kai'Sa": "Kaisa", "Kha'Zix": "Khazix", "Vel'Koz": "Velkoz",
              "Cho'Gath": "Chogath", "LeBlanc": "Leblanc", "Fiddlesticks": "Fiddlesticks",
              "K'Sante": "KSante", "Dr. Mundo": "DrMundo", "Kog'Maw": "KogMaw",
              "Rek'Sai": "RekSai", "Master Yi": "MasterYi", "Jarvan IV": "JarvanIV",
              "Lee Sin": "LeeSin", "Xin Zhao": "XinZhao", "Miss Fortune": "MissFortune",
              "Twisted Fate": "TwistedFate", "Tahm Kench": "TahmKench", "Aurelion Sol": "AurelionSol",
              "Aurora": "Aurora", "Ambessa": "Ambessa", "Hwei": "Hwei", "Smolder": "Smolder"
          };
          return exceptions[name] || name.replace(/[\s'.]/g, ''); 
     }
  %>

<div class="relative w-full h-80 rounded-2xl overflow-hidden mb-12 border border-slate-700 shadow-2xl group">
      
      <div class="absolute inset-0">
          <img src="https://ddragon.leagueoflegends.com/cdn/img/champion/splash/<%= getChampId(mainChamp) %>_0.jpg" 
               class="w-full h-full object-cover object-top opacity-40 group-hover:scale-105 transition-transform duration-1000"
               onerror="this.src='https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Aatrox_0.jpg'">
          <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/60 to-transparent"></div>
          <div class="absolute inset-0 bg-gradient-to-r from-slate-900 via-transparent to-transparent"></div>
      </div>

      <div class="relative z-10 h-full flex flex-col justify-end p-8 md:p-12">
          
          <div class="flex items-end gap-6">
              
              <% 
                 // Usamos 'rol_juego' que es el nombre real en tu BD
                 let rawRol = (jugador.rol_juego || 'FILL').toUpperCase();
                 let displayRol = rawRol;

                 const mapRoles = {
                     'TOP': 'TOP',
                     'JUNGLE': 'JG',  'JGL': 'JG',
                     'MID': 'MID',    'MIDDLE': 'MID',
                     'ADC': 'ADC',    'BOT': 'ADC', 'BOTTOM': 'ADC',
                     'SUPPORT': 'SUP', 'SUPP': 'SUP'
                 };

                 if (mapRoles[rawRol]) {
                     displayRol = mapRoles[rawRol];
                 } else if (rawRol !== 'FILL') {
                     displayRol = rawRol.substring(0, 3);
                 }
              %>

              <div class="mb-1">
                  <h1 class="text-5xl md:text-7xl font-black text-white italic uppercase tracking-tighter leading-none drop-shadow-lg">
                      <%= jugador.nombre_invocador %>
                  </h1>
                  <div class="flex items-center gap-3 mt-2">
                      <% if (jugador.equipo_nombre) { %>
                          <span class="text-2xl text-yellow-500 font-bold uppercase tracking-widest"><%= jugador.equipo_nombre %></span>
                      <% } else { %>
                          <span class="text-slate-500 font-bold uppercase tracking-widest">Agente Libre</span>
                      <% } %>
                  </div>
                  <h4 class="text-3xl md:text-3xl font-black text-white italic uppercase tracking-tighter leading-none drop-shadow-lg">
                      <%= displayRol %>
                  </h4>
              </div>
          </div>

      </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <div class="space-y-6">
          
          <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl relative overflow-hidden group">
              <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                  <i class="fas fa-chart-pie text-6xl text-blue-500"></i>
              </div>
              <div class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-1">KDA Ratio</div>
              <div class="text-5xl font-black text-white italic tracking-tighter"><%= kdaRatio %></div>
              <div class="text-sm text-slate-400 font-mono mt-2">
                  <span class="text-green-400"><%= kills %></span> / <span class="text-red-400"><%= deaths %></span> / <span class="text-yellow-400"><%= assists %></span>
              </div>
          </div>

          <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl relative overflow-hidden group">
              <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                  <i class="fas fa-trophy text-6xl text-yellow-500"></i>
              </div>
              <div class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-1">Winrate</div>
              <div class="text-5xl font-black <%= winrate >= 50 ? 'text-green-400' : 'text-red-400' %> italic tracking-tighter">
                  <%= winrate %>%
              </div>
              <div class="text-sm text-slate-400 font-mono mt-2">
                  <%= wins %>W - <%= games - wins %>L (<%= games %> Games)
              </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
              <div class="bg-slate-900 border border-slate-700 p-4 rounded-xl">
                  <div class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">CS / Min</div>
                  <div class="text-2xl font-black text-white"><%= avgCs %></div>
              </div>
              <div class="bg-slate-900 border border-slate-700 p-4 rounded-xl">
                  <div class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Dmg / Min</div>
                  <div class="text-2xl font-black text-white"><%= avgDmg %>k</div>
              </div>
          </div>

      </div>

      <div class="lg:col-span-2 space-y-6">
          <h3 class="text-xl text-white font-black italic uppercase tracking-widest border-b border-slate-800 pb-2">
              Top Campeones
          </h3>

          <div class="grid gap-3">
              <% if (typeof topChampions !== 'undefined' && topChampions.length > 0) { %>
                  <% topChampions.forEach(champ => { 
                      const cId = getChampId(champ.champion_name);
                      const cWins = Number(champ.victorias);
                      const cGames = Number(champ.partidas);
                      const cWr = cGames > 0 ? ((cWins / cGames) * 100).toFixed(0) : 0;
                      const cKills = Number(champ.total_kills);
                      const cDeaths = Number(champ.total_deaths);
                      const cAssists = Number(champ.total_assists);
                      const cKda = cDeaths === 0 ? (cKills+cAssists) : ((cKills+cAssists)/cDeaths).toFixed(2);
                  %>
                  <div class="relative h-20 w-full rounded-md overflow-hidden group border border-slate-800 hover:border-yellow-500/50 transition-all block bg-slate-900">
                      
                      <div class="absolute left-0 top-0 bottom-0 w-64 z-0">
                          <img src="https://ddragon.leagueoflegends.com/cdn/img/champion/centered/<%= cId %>_0.jpg" 
                               class="w-full h-full object-cover object-center scale-110 opacity-60 group-hover:opacity-100 transition-all duration-500"
                               style="-webkit-mask-image: linear-gradient(to right, black 40%, transparent 100%); mask-image: linear-gradient(to right, black 40%, transparent 100%);">
                      </div>

                      <div class="relative z-10 h-full flex items-center justify-between px-6 pl-32 md:pl-48">
                          <div class="flex flex-col">
                              <span class="text-2xl font-black text-white italic tracking-tighter uppercase"><%= champ.champion_name %></span>
                              <span class="text-xs text-slate-400 font-bold"><%= cGames %> Partidas</span>
                          </div>
                          <div class="flex items-center gap-8 text-right">
                              <div>
                                  <div class="text-xl font-bold <%= cWr >= 50 ? 'text-green-400' : 'text-slate-400' %>"><%= cWr %>%</div>
                                  <div class="text-[9px] text-slate-500 uppercase font-bold tracking-widest">Winrate</div>
                              </div>
                              <div class="hidden md:block">
                                  <div class="text-xl font-bold text-yellow-500"><%= cKda %></div>
                                  <div class="text-[9px] text-slate-500 uppercase font-bold tracking-widest">KDA</div>
                              </div>
                          </div>
                      </div>
                  </div>
                  <% }) %>
              <% } else { %>
                  <div class="text-slate-500 italic p-4 text-center bg-slate-900 rounded border border-slate-800">
                      Sin datos de campeones aún.
                  </div>
              <% } %>
          </div>

          <h3 class="text-xl text-white font-black italic uppercase tracking-widest border-b border-slate-800 pb-2 mt-8">
              Historial Reciente
          </h3>
          
          <div class="space-y-2">
              <% if (typeof estadisticas !== 'undefined' && estadisticas.length > 0) { %>
                  <% estadisticas.slice(0, 5).forEach(stat => { 
                      const isWin = (stat.win === 1);
                      const sCId = getChampId(stat.champion_name);
                  %>
                  <a href="/partida/<%= stat.partida_id %>" class="flex items-center justify-between bg-slate-900 border-l-4 <%= isWin ? 'border-l-green-500' : 'border-l-red-500' %> border-y border-r border-slate-800 p-3 hover:bg-slate-800 transition group">
                      
                      <div class="flex items-center gap-4">
                          <img src="https://ddragon.leagueoflegends.com/cdn/<%= DDRAGON_VER %>/img/champion/<%= sCId %>.png" 
                               class="w-10 h-10 rounded-sm border border-slate-600 grayscale group-hover:grayscale-0 transition shadow-lg"
                               onerror="this.src='https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/v1/champion-icons/-1.png'">
                          
                          <div class="flex flex-col">
                              <span class="font-bold text-white text-sm <%= isWin ? 'text-green-400' : 'text-red-400' %>"><%= isWin ? 'Victoria' : 'Derrota' %></span>
                              <span class="text-xs text-slate-500 font-bold uppercase"><%= stat.champion_name %></span>
                          </div>
                      </div>

                      <div class="flex items-center gap-6">
                          <div class="text-right">
                              <div class="font-mono font-bold text-slate-200"><%= stat.kills %>/<%= stat.deaths %>/<%= stat.assists %></div>
                              <div class="text-[9px] text-slate-500 font-bold uppercase">KDA</div>
                          </div>
                          <div class="hidden md:block text-right w-16">
                              <div class="font-bold text-slate-400"><%= stat.cs_min %></div>
                              <div class="text-[9px] text-slate-600 font-bold uppercase">CS</div>
                          </div>
                          <i class="fas fa-chevron-right text-slate-700 group-hover:text-yellow-500 transition"></i>
                      </div>

                  </a>
                  <% }) %>
              <% } else { %>
                  <div class="text-slate-500 italic p-4 text-center bg-slate-900 rounded border border-slate-800">
                      No hay partidas registradas.
                  </div>
              <% } %>
          </div>

      </div>

  </div>

  <% } else { %>
    <div class="text-center py-20">
        <h2 class="text-3xl text-white font-black">Jugador no encontrado</h2>
        <a href="/" class="text-yellow-500 mt-4 block">Volver al inicio</a>
    </div>
  <% } %>

</main>

<%- include('partials/footer') %>
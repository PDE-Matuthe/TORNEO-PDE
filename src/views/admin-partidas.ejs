<%- include('partials/head') %>

<div class="flex min-h-screen bg-slate-950 font-sans text-slate-300">
    
    <%- include('partials/admin-sidebar', { active: 'partidas' }) %>

    <main class="flex-1 ml-64 p-8 relative overflow-y-auto min-h-screen">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-black text-white tracking-tight uppercase italic">Gestión de <span class="text-yellow-500">Partidas</span></h1>
                <p class="text-slate-500 text-sm mt-1">Administra los enfrentamientos, resultados y horarios.</p>
            </div>
            <div class="flex gap-3">
                 <a href="/admin/partidas/crear" class="inline-flex items-center px-5 py-2.5 bg-yellow-500 hover:bg-yellow-400 text-slate-950 text-sm font-bold uppercase tracking-wider rounded shadow-lg shadow-yellow-500/20 transition-all transform hover:-translate-y-0.5">
                    <i class="fas fa-plus mr-2"></i> Nueva Partida
                </a>
            </div>
        </div>

        <div class="bg-slate-900/50 border border-slate-800 rounded-lg p-4 mb-6 flex flex-wrap gap-4 items-center">
          <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Filtrar por:</span>
          
          <select id="filtroTorneo" onchange="aplicarFiltros()" class="bg-slate-950 border border-slate-700 text-slate-300 text-sm rounded px-3 py-1.5 focus:border-yellow-500 focus:outline-none min-w-[200px]">
              <option value="todos">Todos los Torneos</option>
              <% if (locals.torneos) { %>
                  <% torneos.forEach(t => { %>
                      <option value="<%= t.id %>" <%= (locals.filtroTorneo === t.id) ? 'selected' : '' %>>
                          <%= t.nombre %>
                      </option>
                  <% }) %>
              <% } %>
          </select>

          <select id="filtroFase" onchange="aplicarFiltros()" class="bg-slate-950 border border-slate-700 text-slate-300 text-sm rounded px-3 py-1.5 focus:border-yellow-500 focus:outline-none">
              <option value="todas">Todas las Fases</option>
              <% const fases = ['Fase de Grupos', 'Dieciseisavos', 'Octavos', 'Cuartos', 'Semifinal', 'Final']; %>
              <% fases.forEach(f => { %>
                  <option value="<%= f %>" <%= (locals.filtroFase === f) ? 'selected' : '' %>>
                      <%= f %>
                  </option>
              <% }) %>
          </select>

          <% if (locals.filtroTorneo !== 'todos' || locals.filtroFase !== 'todas') { %>
              <a href="/admin/partidas" class="text-xs text-red-400 hover:text-red-300 underline ml-auto">
                  <i class="fas fa-times mr-1"></i> Borrar filtros
              </a>
          <% } %>
      </div>

        <div class="bg-slate-900 border border-slate-800 rounded-lg shadow-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-800">
                    <thead class="bg-slate-950/50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">ID / Fecha</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Enfrentamiento</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Torneo / Fase</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Orden Bracket</th> <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Estado</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-slate-400 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800/50">
                        <% if (partidas && partidas.length > 0) { %>
                            <% partidas.forEach(partida => { %>
                            <tr class="hover:bg-slate-800/30 transition-colors group">
                                
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-bold text-white font-mono">
                                        <%= new Date(partida.fecha_partida).toLocaleDateString() %>
                                    </div>
                                    <div class="text-xs text-slate-500 font-mono mt-0.5">
                                        <%= new Date(partida.fecha_partida).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                                    </div>
                                    <div class="text-[10px] text-slate-600 font-mono mt-1">#<%= partida.id.substring(0,6) %></div>
                                </td>

                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center space-x-3">
                                        <div class="flex items-center justify-end w-28 space-x-2">
                                            <span class="text-sm font-medium text-slate-300 truncate"><%= partida.azul_nombre || 'TBD' %></span>
                                            <img class="h-6 w-6 rounded-full bg-slate-800 object-contain p-0.5 border border-blue-500/30" src="<%= partida.azul_logo || '/images/default-logo.png' %>" alt="">
                                        </div>
                                        
                                        <span class="text-slate-600 font-black text-xs">VS</span>
                                        
                                        <div class="flex items-center w-28 space-x-2">
                                            <img class="h-6 w-6 rounded-full bg-slate-800 object-contain p-0.5 border border-red-500/30" src="<%= partida.rojo_logo || '/images/default-logo.png' %>" alt="">
                                            <span class="text-sm font-medium text-slate-300 truncate"><%= partida.rojo_nombre || 'TBD' %></span>
                                        </div>
                                    </div>
                                    <% if (partida.ganador_id) { %>
                                        <div class="mt-2 text-center">
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-green-900/30 text-green-400 border border-green-500/20">
                                                <i class="fas fa-crown mr-1 text-[8px]"></i>
                                                Ganador: <%= (partida.ganador_id === partida.equipo_azul_id) ? partida.azul_nombre : partida.rojo_nombre %>
                                            </span>
                                        </div>
                                    <% } %>
                                </td>

                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-slate-300 font-bold"><%= partida.torneo_nombre %></div>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-800 text-slate-400 border border-slate-700 mt-1">
                                        <%= partida.fase_torneo %>
                                    </span>
                                </td>
                                
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <form action="/admin/partidas/<%= partida.id %>/orden" method="POST" class="flex items-center gap-2">
                                        
                                        <input type="hidden" name="torneo_actual" value="<%= locals.filtroTorneo || 'todos' %>">
                                        <input type="hidden" name="fase_actual" value="<%= locals.filtroFase || 'todas' %>">
                                        
                                        <input 
                                            type="number" 
                                            name="posicion_bracket" 
                                            value="<%= partida.posicion_bracket || 0 %>" 
                                            min="1"
                                            class="w-16 bg-slate-950 border border-slate-700 rounded px-2 py-1 text-white text-center text-sm focus:border-yellow-500 focus:outline-none transition-colors placeholder-slate-600"
                                        >
                                        <button type="submit" ...> <i class="fas fa-save text-xs"></i> </button>
                                    </form>
                                </td>

                                <td class="px-6 py-4 whitespace-nowrap">
                                    <% if (partida.estado === 'FINALIZADA' || partida.estado === 'FINALIZADO') { %>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-slate-800 text-slate-400 border border-slate-700">
                                            Finalizada
                                        </span>
                                    <% } else if (partida.estado === 'EN_VIVO' || partida.estado === 'EN VIVO') { %>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-red-900/30 text-red-500 border border-red-500/30 animate-pulse">
                                            <span class="w-1.5 h-1.5 bg-red-500 rounded-full mr-1.5"></span>
                                            En Vivo
                                        </span>
                                    <% } else { %>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-900/30 text-blue-400 border border-blue-500/30">
                                            Programada
                                        </span>
                                    <% } %>
                                </td>

                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <div class="flex justify-end gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                                        <a href="/admin/partidas/<%= partida.id %>/cargar" class="text-blue-400 hover:text-blue-300 bg-blue-900/20 hover:bg-blue-900/40 p-2 rounded transition-colors" title="Cargar Resultados">
                                            <i class="fas fa-file-upload"></i>
                                        </a>
                                        <a href="/admin/partidas/<%= partida.id %>/editar" class="text-yellow-500 hover:text-yellow-400 bg-yellow-900/20 hover:bg-yellow-900/40 p-2 rounded transition-colors" title="Editar Detalles">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button onclick="confirmarBorrado('<%= partida.id %>')" class="text-red-500 hover:text-red-400 bg-red-900/20 hover:bg-red-900/40 p-2 rounded transition-colors" title="Eliminar">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="6" class="px-6 py-12 text-center text-slate-500">
                                    <i class="fas fa-gamepad text-4xl mb-3 opacity-30"></i>
                                    <p class="text-sm">No hay partidas registradas aún.</p>
                                    <a href="/admin/partidas/crear" class="text-yellow-500 hover:underline text-xs mt-2 inline-block">Crear la primera</a>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>

    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function confirmarBorrado(id) {
        Swal.fire({
            title: '¿Estás seguro?',
            text: "No podrás revertir esto. Se perderán las estadísticas asociadas.",
            icon: 'warning',
            background: '#0f172a',
            color: '#fff',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#334155',
            confirmButtonText: 'Sí, borrar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                // SOLUCIÓN: Crear un formulario invisible para enviar POST
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/admin/partidas/${id}/delete`;
                document.body.appendChild(form);
                form.submit();
            }
        })
    }

    function aplicarFiltros() {
        const torneo = document.getElementById('filtroTorneo').value;
        const fase = document.getElementById('filtroFase').value;
        // Redirige a la misma página con los parámetros Query
        window.location.href = `/admin/partidas?torneo=${torneo}&fase=${fase}`;
    }
</script>

</body>
</html>